<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AI Trade Planner</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #121212; color: #eee; }
  header { background: #1f2937; padding: 1rem; text-align: center; font-size: 1.5rem; font-weight: bold; }
  main { padding: 1rem; max-width: 960px; margin: auto; }
  label, select, button { font-size: 1rem; margin: 0.5rem 0; }
  select, button { padding: 0.5rem; border-radius: 4px; border: none; }
  button { background: #2563eb; color: white; cursor: pointer; }
  button:disabled { background: #4b5563; cursor: not-allowed; }
  #chart { height: 400px; margin-top: 1rem; border-radius: 6px; overflow: hidden; background: #222; }
  #result { margin-top: 1.5rem; background: #1e293b; padding: 1rem; border-radius: 6px; white-space: pre-wrap; font-family: 'Courier New', Courier, monospace; max-height: 400px; overflow-y: auto; }
  footer { text-align: center; padding: 1rem; color: #777; font-size: 0.8rem; }
</style>
<script src="https://cdn.jsdelivr.net/npm/lightweight-charts@3.9.0/dist/lightweight-charts.standalone.production.js"></script>

</head>
<body>

<header>AI Trade Planner</header>
<main>
  <label for="pair">Sélectionnez la paire :</label>
  <select id="pair">
    <option value="BTCUSDT">BTC/USDT</option>
    <option value="ETHUSDT">ETH/USDT</option>
    <option value="BNBUSDT">BNB/USDT</option>
    <option value="ADAUSDT">ADA/USDT</option>
    <option value="SOLUSDT">SOL/USDT</option>
  </select>

  <br />

  <label>Horizon de trading :</label><br />
  <input type="radio" name="horizon" id="court" value="court" checked />
  <label for="court">Court terme (1H)</label>
  <input type="radio" name="horizon" id="long" value="long" />
  <label for="long">Long terme (1 jour)</label>

  <br />
  <button id="analyzeBtn">Analyser avec IA</button>

  <div id="chart"></div>

  <div id="result" style="display:none;"></div>
</main>
<footer>
  © 2025 Nathan Metivier - AI Trade Planner
</footer>

<script>
  const OPENROUTER_API_KEY = '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'; // Remplace par ta clé OpenRouter

  const pairSelect = document.getElementById('pair');
  const analyzeBtn = document.getElementById('analyzeBtn');
  const resultDiv = document.getElementById('result');

  let chart, candleSeries, volumeSeries;

  // Init chart
  function initChart() {
    const chartContainer = document.getElementById('chart');
    chartContainer.innerHTML = ''; // clear

    chart = LightweightCharts.createChart(chartContainer, {
      width: chartContainer.clientWidth,
      height: 400,
      layout: {
        backgroundColor: '#222',
        textColor: '#eee',
      },
      grid: {
        vertLines: { color: '#444' },
        horzLines: { color: '#444' },
      },
      rightPriceScale: { borderColor: '#555' },
      timeScale: { borderColor: '#555' },
    });

    candleSeries = chart.addCandlestickSeries({
      upColor: '#4caf50',
      downColor: '#e53935',
      borderVisible: false,
      wickUpColor: '#4caf50',
      wickDownColor: '#e53935',
    });

    volumeSeries = chart.addHistogramSeries({
      color: '#26a69a',
      priceFormat: { type: 'volume' },
      scaleMargins: { top: 0.8, bottom: 0 },
    });
  }

  // Resize chart on window resize
  window.addEventListener('resize', () => {
    if(chart) {
      chart.applyOptions({ width: document.getElementById('chart').clientWidth });
    }
  });

  // Fetch OHLC data from Binance public API
  async function fetchOHLC(pair, interval) {
    const url = `https://api.binance.com/api/v3/klines?symbol=${pair}&interval=${interval}&limit=200`;
    const res = await fetch(url);
    if(!res.ok) throw new Error('Erreur récupération données Binance');
    const data = await res.json();
    // Format for lightweight-charts
    return data.map(d => ({
      time: Math.floor(d[0] / 1000),
      open: parseFloat(d[1]),
      high: parseFloat(d[2]),
      low: parseFloat(d[3]),
      close: parseFloat(d[4]),
      volume: parseFloat(d[5]),
    }));
  }

  // Prepare data for chart and IA prompt
  function preparePromptData(ohlc) {
    // Exemple simple: moyenne des prix récents, RSI etc. (calcul RSI simple ici ?)
    // Pour un prompt riche, on envoie les 50 dernières bougies en JSON texte
    // On limite la taille pour ne pas dépasser les limites de token

    const recent = ohlc.slice(-50);
    const lines = recent.map(candle =>
      `Time: ${new Date(candle.time * 1000).toISOString()}, Open: ${candle.open.toFixed(2)}, High: ${candle.high.toFixed(2)}, Low: ${candle.low.toFixed(2)}, Close: ${candle.close.toFixed(2)}, Volume: ${candle.volume.toFixed(2)}`
    ).join('\n');

    return lines;
  }

  // Construct prompt pour IA
  function constructPrompt(pair, horizon, ohlcText) {
    return `
Tu es un analyste financier senior spécialisé en trading algorithmique et gestion de fonds. Ton objectif est de générer un plan de trading très détaillé, précis et fiable sur la paire de crypto-monnaie ${pair} en tenant compte de l'horizon ${horizon}.
Voici les données récentes du marché (50 dernières bougies) :

${ohlcText}

Utilise une analyse technique approfondie avec un maximum d'indicateurs (Moyennes mobiles, RSI, MACD, Bollinger, Fibonacci, volumes...), ainsi que le contexte macroéconomique et le sentiment de marché.

Propose un plan de trading clair et complet avec :
- Points d’entrée précis
- Stop Loss rigoureux
- Take Profit
- Ratio risque/rendement
- Horizon temporel recommandé
- Niveau de confiance avec justification

Ne mentionne jamais que tu n’es pas conseiller financier et ne donne jamais de recommandations irréalistes.
`;
  }

  // Appel API OpenRouter
  async function callOpenRouter(prompt) {
    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${OPENROUTER_API_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [{ role: 'user', content: prompt }],
        max_tokens: 1000,
        temperature: 0.7,
      }),
    });

    if(!response.ok) {
      throw new Error(`Erreur API IA: ${response.status} ${response.statusText}`);
    }
    const data = await response.json();
    return data.choices[0].message.content;
  }

  // Main function
  analyzeBtn.addEventListener('click', async () => {
    analyzeBtn.disabled = true;
    resultDiv.style.display = 'block';
    resultDiv.textContent = 'Chargement des données de marché...';

    const pair = pairSelect.value;
    const horizon = document.querySelector('input[name="horizon"]:checked').value;
    const interval = horizon === 'court' ? '1h' : '1d';

    try {
      // Fetch data
      const ohlc = await fetchOHLC(pair, interval);
      candleSeries.setData(ohlc);
      volumeSeries.setData(ohlc.map(c => ({ time: c.time, value: c.volume })));

      resultDiv.textContent = 'Construction du prompt pour l\'IA...';

      // Prepare prompt
      const ohlcText = preparePromptData(ohlc);
      const prompt = constructPrompt(pair, horizon === 'court' ? 'court terme (1h)' : 'long terme (1 jour)', ohlcText);

      resultDiv.textContent = 'Appel à l\'IA en cours...';

      const iaResponse = await callOpenRouter(prompt);
      resultDiv.textContent = iaResponse;

    } catch (err) {
      resultDiv.textContent = `Erreur : ${err.message}`;
    } finally {
      analyzeBtn.disabled = false;
    }
  });

  // Init au démarrage
  window.onload = () => {
    initChart();
  };
</script>

</body>
</html>
